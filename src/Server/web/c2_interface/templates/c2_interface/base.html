<!doctype html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>
            {% block title %}{{ page_title }} - PrometheanProxy C2{% endblock %}
        </title>

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Alpine.js for reactive components -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>

        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <style>
            /* Custom scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1f2937;
            }
            ::-webkit-scrollbar-thumb {
                background: #4b5563;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #6b7280;
            }

            /* Animations */
            @keyframes pulse-slow {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            .pulse-slow {
                animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            /* Terminal-like font */
            .font-mono-terminal {
                font-family: "Courier New", Courier, monospace;
            }

            /* Glow effects */
            .glow-green {
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            }
            .glow-red {
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }
            .glow-blue {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            }

            /* Status indicators */
            .status-online {
                background-color: #10b981;
                box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            }
            .status-offline {
                background-color: #ef4444;
                box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            }
            .status-pending {
                background-color: #f59e0b;
                box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
            }
        </style>

        {% block extra_css %}{% endblock %}
    </head>
    <body
        class="h-full bg-gray-900 text-gray-100"
        x-data="{ sidebarOpen: true, mobileMenuOpen: false }"
    >
        <!-- Mobile menu button -->
        <div class="lg:hidden fixed top-4 left-4 z-50">
            <button
                @click="mobileMenuOpen = !mobileMenuOpen"
                class="p-2 rounded-md bg-gray-800 text-gray-300 hover:bg-gray-700 focus:outline-none"
            >
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <div class="flex h-full">
            <!-- Sidebar -->
            <aside
                class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 border-r border-gray-700 transform transition-transform duration-200 ease-in-out lg:translate-x-0"
                :class="{ '-translate-x-full': !mobileMenuOpen && window.innerWidth < 1024, 'translate-x-0': mobileMenuOpen || window.innerWidth >= 1024 }"
            >
                <!-- Logo -->
                <div
                    class="flex items-center justify-between p-6 border-b border-gray-700"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-600 rounded-lg flex items-center justify-center"
                        >
                            <i class="fas fa-fire text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">
                                Promethean
                            </h1>
                            <p class="text-xs text-gray-400">C2 Framework</p>
                        </div>
                    </div>
                    <button
                        @click="mobileMenuOpen = false"
                        class="lg:hidden text-gray-400 hover:text-white"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Navigation -->
                <nav
                    class="p-4 space-y-2 overflow-y-auto h-[calc(100vh-180px)]"
                >
                    {% block sidebar_nav %}
                    <a
                        href="{% url 'c2_interface:dashboard' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'dashboard' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-chart-line w-5"></i>
                        <span>Dashboard</span>
                    </a>

                    <a
                        href="{% url 'c2_interface:beacons_list' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'beacons' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-satellite-dish w-5"></i>
                        <span>Beacons</span>
                        <span
                            class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full"
                            id="beacon-count"
                            >0</span
                        >
                    </a>

                    <a
                        href="{% url 'c2_interface:sessions_list' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'sessions' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-terminal w-5"></i>
                        <span>Sessions</span>
                        <span
                            class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-full"
                            id="session-count"
                            >0</span
                        >
                    </a>

                    <a
                        href="{% url 'c2_interface:commands' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'commands' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-code w-5"></i>
                        <span>Commands</span>
                    </a>

                    <div class="border-t border-gray-700 my-4"></div>

                    <a
                        href="{% url 'c2_interface:logs' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'logs' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-list-ul w-5"></i>
                        <span>Logs</span>
                    </a>

                    <a
                        href="{% url 'c2_interface:settings' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors {% if active_page == 'settings' %}bg-gray-700 text-white{% else %}text-gray-300 hover:bg-gray-700 hover:text-white{% endif %}"
                    >
                        <i class="fas fa-cog w-5"></i>
                        <span>Settings</span>
                    </a>

                    <a
                        href="{% url 'c2_interface:about' %}"
                        class="flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors text-gray-300 hover:bg-gray-700 hover:text-white"
                    >
                        <i class="fas fa-info-circle w-5"></i>
                        <span>About</span>
                    </a>
                    {% endblock %}
                </nav>

                <!-- User info -->
                <div
                    class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-700 bg-gray-800"
                >
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center"
                        >
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="flex-1">
                            <p
                                class="text-sm font-medium text-white"
                                id="current-user"
                            >
                                Not authenticated
                            </p>
                            <p
                                class="text-xs text-gray-400"
                                id="connection-status"
                            >
                                <span
                                    class="inline-block w-2 h-2 rounded-full bg-gray-500 mr-1"
                                ></span>
                                Disconnected
                            </p>
                        </div>
                        <button
                            onclick="logout()"
                            class="text-gray-400 hover:text-white"
                        >
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main content -->
            <main class="flex-1 lg:ml-64 overflow-auto">
                <!-- Top bar -->
                <div
                    class="bg-gray-800 border-b border-gray-700 px-6 py-4 sticky top-0 z-30"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="lg:hidden w-12"></div>
                            <h2 class="text-2xl font-bold text-white">
                                {{ page_title }}
                            </h2>
                            <div
                                id="sync-status"
                                class="flex items-center space-x-2 text-sm"
                            >
                                <span
                                    class="inline-block w-2 h-2 rounded-full bg-gray-500 pulse-slow"
                                ></span>
                                <span class="text-gray-400">Connecting...</span>
                            </div>
                        </div>

                        <div class="flex items-center space-x-4">
                            <!-- Notifications -->
                            <div class="relative" x-data="{ open: false }">
                                <button
                                    @click="open = !open"
                                    class="relative p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700"
                                >
                                    <i class="fas fa-bell"></i>
                                    <span
                                        id="notification-badge"
                                        class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"
                                    ></span>
                                </button>

                                <div
                                    x-show="open"
                                    @click.away="open = false"
                                    x-cloak
                                    class="absolute right-0 mt-2 w-80 bg-gray-800 rounded-lg shadow-xl border border-gray-700 py-2 z-50"
                                >
                                    <div
                                        class="px-4 py-2 border-b border-gray-700"
                                    >
                                        <h3
                                            class="text-sm font-semibold text-white"
                                        >
                                            Notifications
                                        </h3>
                                    </div>
                                    <div
                                        id="notification-list"
                                        class="max-h-96 overflow-y-auto"
                                    >
                                        <div
                                            class="px-4 py-8 text-center text-gray-400 text-sm"
                                        >
                                            No new notifications
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Search -->
                            <div class="hidden md:block">
                                <input
                                    type="text"
                                    placeholder="Search..."
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500 w-64"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page content -->
                <div class="p-6">{% block content %}{% endblock %}</div>
            </main>
        </div>

        <!-- Toast notifications -->
        <div
            id="toast-container"
            class="fixed bottom-4 right-4 z-50 space-y-2"
        ></div>

        <!-- Base JavaScript -->
        <script>
            // Global API client
            const API_BASE = "";
            let authToken = localStorage.getItem("auth_token");
            let wsConnection = null;
            let wsReconnectTimer = null;

            // API helper functions
            async function apiRequest(endpoint, method = "GET", data = null) {
                const headers = {
                    "Content-Type": "application/json",
                };

                if (authToken) {
                    headers["Authorization"] = `Bearer ${authToken}`;
                }

                const options = {
                    method: method,
                    headers: headers,
                };

                if (data && method !== "GET") {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(
                        `${API_BASE}${endpoint}`,
                        options,
                    );

                    if (response.status === 401) {
                        // Token expired or invalid
                        authToken = null;
                        localStorage.removeItem("auth_token");
                        window.location.href = "/login/";
                        return null;
                    }

                    if (!response.ok) {
                        // Non-2xx response
                        const errorText = await response.text();
                        throw new Error(
                            `HTTP ${response.status}: ${errorText}`,
                        );
                    }

                    return await response.json();
                } catch (error) {
                    console.error("API request failed:", error);
                    showToast("API request failed: " + error.message, "error");
                    throw error;
                }
            }

            // Authentication
            async function login(username, password) {
                const response = await apiRequest("/api/auth/login/", "POST", {
                    username,
                    password,
                });

                if (response && response.token) {
                    authToken = response.token;
                    localStorage.setItem("auth_token", authToken);
                    localStorage.setItem("username", username);
                    connectWebSocket();
                    updateAuthStatus();
                    return true;
                }
                return false;
            }

            async function logout() {
                await apiRequest("/api/auth/logout/", "POST");
                authToken = null;
                localStorage.removeItem("auth_token");
                localStorage.removeItem("username");
                if (wsConnection) {
                    wsConnection.close();
                }
                window.location.href = "/login/";
            }

            // WebSocket connection
            function connectWebSocket() {
                const protocol =
                    window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.host}/ws/events/`;

                wsConnection = new WebSocket(wsUrl);

                wsConnection.onopen = () => {
                    console.log("WebSocket connected");
                    updateSyncStatus("connected");
                    if (wsReconnectTimer) {
                        clearInterval(wsReconnectTimer);
                        wsReconnectTimer = null;
                    }
                };

                wsConnection.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };

                wsConnection.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    updateSyncStatus("error");
                };

                wsConnection.onclose = () => {
                    console.log("WebSocket disconnected");
                    updateSyncStatus("disconnected");
                    // Attempt to reconnect
                    if (!wsReconnectTimer) {
                        wsReconnectTimer = setInterval(() => {
                            console.log("Attempting to reconnect WebSocket...");
                            connectWebSocket();
                        }, 5000);
                    }
                };
            }

            function handleWebSocketMessage(message) {
                console.log("WebSocket message:", message);

                switch (message.type) {
                    case "connected":
                        console.log("WebSocket connection confirmed");
                        break;
                    case "beacon_event":
                        handleBeaconEvent(message.data);
                        break;
                    case "command_event":
                        handleCommandEvent(message.data);
                        break;
                    case "heartbeat":
                        // Keep-alive
                        break;
                    default:
                        console.log("Unknown message type:", message.type);
                }
            }

            function handleBeaconEvent(data) {
                showToast(`Beacon event: ${data.event}`, "info");
                updateConnectionCounts();
            }

            function handleCommandEvent(data) {
                showToast(`Command ${data.event}`, "info");
            }

            // UI updates
            function updateSyncStatus(status) {
                const statusEl = document.getElementById("sync-status");
                const statusMap = {
                    connected: {
                        color: "bg-green-500",
                        text: "Connected",
                        pulse: "",
                    },
                    disconnected: {
                        color: "bg-red-500",
                        text: "Disconnected",
                        pulse: "pulse-slow",
                    },
                    error: {
                        color: "bg-orange-500",
                        text: "Connection Error",
                        pulse: "pulse-slow",
                    },
                };

                const s = statusMap[status] || statusMap["disconnected"];
                statusEl.innerHTML = `
                <span class="inline-block w-2 h-2 rounded-full ${s.color} ${s.pulse}"></span>
                <span class="text-gray-400">${s.text}</span>
            `;
            }

            function updateAuthStatus() {
                const username = localStorage.getItem("username");
                if (username) {
                    document.getElementById("current-user").textContent =
                        username;
                    document.getElementById("connection-status").innerHTML = `
                    <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>
                    Authenticated
                `;
                }
            }

            async function updateConnectionCounts() {
                try {
                    const connections = await apiRequest(
                        "/api/connections/",
                        "GET",
                    );
                    if (connections) {
                        const beaconCount = connections.beacons?.length || 0;
                        const sessionCount = connections.sessions?.length || 0;

                        document.getElementById("beacon-count").textContent =
                            beaconCount;
                        document.getElementById("session-count").textContent =
                            sessionCount;
                    }
                } catch (error) {
                    console.error("Failed to update connection counts:", error);
                }
            }

            // Toast notifications
            function showToast(message, type = "info") {
                const container = document.getElementById("toast-container");
                const toast = document.createElement("div");

                const colors = {
                    success: "bg-green-500",
                    error: "bg-red-500",
                    warning: "bg-orange-500",
                    info: "bg-blue-500",
                };

                const icons = {
                    success: "fa-check-circle",
                    error: "fa-exclamation-circle",
                    warning: "fa-exclamation-triangle",
                    info: "fa-info-circle",
                };

                toast.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-80 transform transition-all duration-300`;
                toast.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;

                container.appendChild(toast);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    toast.style.opacity = "0";
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", () => {
                updateAuthStatus();

                if (authToken) {
                    connectWebSocket();
                    updateConnectionCounts();
                    setInterval(updateConnectionCounts, 30000); // Update every 30s
                } else if (!window.location.pathname.includes("/login/")) {
                    window.location.href = "/login/";
                }
            });
        </script>

        {% block extra_js %}{% endblock %}
    </body>
</html>
