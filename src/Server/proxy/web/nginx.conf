# Nginx reverse proxy configuration dedicated to the web server
# - Proxies incoming HTTP traffic on port 80 to the internal web service at web:8001
# - Supports WebSockets
# - Provides a simple /healthz endpoint for container health checks
#
# Assumptions:
# - This container is on the same Docker network as the "web" service (Docker DNS resolves "web").
# - TLS termination is not configured here; add ssl configs later if required.

pid  /tmp/nginx.pid;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    keepalive_timeout  65;
    types_hash_max_size 2048;

    # Compression for common web assets
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 10240;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;

    # Proxy behavior tuned for a Django/WSGI-style app and WebSockets
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_connect_timeout 60s;

    # Preserve original scheme if behind another reverse proxy
    map $http_x_forwarded_proto $proxy_x_forwarded_proto {
        default $http_x_forwarded_proto;
        ""      $scheme;
    }

    # Map Upgrade header to a proper Connection value
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Upstream backend (Docker service name)
    upstream promethean_web {
        server web:8001;
        keepalive 32;
    }

    # ------------------------------------------------
    # Web reverse proxy (external HTTP:80 -> web:8001)
    # ------------------------------------------------
    server {
        listen 80;
        server_name _;

        # Common proxy headers
        set $proxy_host $host;

        # Root location proxies all app traffic to upstream
        location / {
            proxy_pass http://promethean_web;

            # Standard proxy headers
            proxy_set_header Host              $proxy_host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host  $proxy_host;
            proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;

            # WebSocket support (Channels/Socket.IO)
            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Buffers for larger responses (tables, lists)
            proxy_buffers 8 64k;
            proxy_busy_buffers_size 128k;
        }

        # Optional: static assets bypass (uncomment if the app serves static files separately)
        # location /static/ {
        #     proxy_pass http://promethean_web;
        # }

        # Health check
        location = /healthz {
            return 200 "ok\n";
        }
    }
}
