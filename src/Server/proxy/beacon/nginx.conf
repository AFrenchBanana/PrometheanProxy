# Nginx reverse proxy configuration dedicated to the beacon server
# - Proxies incoming HTTP traffic on port 8081 to the internal beacon endpoint at server:2001
# - Supports long-polling and optional WebSockets
# - Provides a simple /healthz endpoint for container health checks
#
# Assumptions:
# - This container is on the same Docker network as the "server" service (Docker DNS resolves "server").
# - Beacon server is plain HTTP by design; TLS termination can be added here later if required.

pid /tmp/nginx.pid;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    keepalive_timeout  65;
    types_hash_max_size 2048;

    # Compression (generally safe; disable if it interferes with specific beacon flows)
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 10240;
    gzip_types text/plain application/json text/xml application/xml application/javascript application/octet-stream;

    # Beacon traffic can be long-lived (long-polling). Increase timeouts.
    proxy_buffering off;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_connect_timeout 60s;

    # Preserve original scheme if behind another reverse proxy
    map $http_x_forwarded_proto $proxy_x_forwarded_proto {
        default $http_x_forwarded_proto;
        ""      $scheme;
    }

    # Map Upgrade header to a proper Connection value
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Upstream backend (Docker service name)
    # Select backend based on Upgrade header:
    # - default (HTTP/long-poll): server:8000
    # - websocket upgraded connections: server:2000
    map $http_upgrade $beacon_backend {
        default   server:8000;
        websocket server:2000;
    }

    # --------------------------------------------------------
    # Beacon reverse proxy (external HTTP:8081 -> server:2001)
    # --------------------------------------------------------
    server {
        listen 8081;
        server_name _;

        # Common proxy headers
        set $proxy_host $host;

        # Forward all paths to the beacon server.
        # If you later want to constrain to specific endpoints, add location blocks.
        location / {
            proxy_pass http://$beacon_backend;

            # Standard proxy headers
            proxy_set_header Host              $proxy_host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host  $proxy_host;
            proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;

            # Long-poll/WebSocket compatibility
            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Buffers (tuned modestly; adjust if needed)
            proxy_buffers 8 64k;
            proxy_busy_buffers_size 128k;
        }

        # Example of narrowing to a known beacon prefix (uncomment if desired)
        # location /beacon/ {
        #     proxy_pass http://promethean_beacon;
        # }

        # Health check
        location = /healthz {
            return 200 "ok\n";
        }
    }
}
