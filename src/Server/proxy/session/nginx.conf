# Nginx stream proxy configuration for raw TCP sessions
# - Listens externally on port 2001
# - Forwards raw TCP traffic to the internal server at server:2000
#
# Notes:
# - This uses Nginx's stream module to proxy non-HTTP traffic.
# - Ensure this container shares a Docker network with the "server" service so "server" DNS resolves.
# - If you need TLS termination for TCP, you can add ssl directives to the stream server block later.

# Run nginx worker processes automatically based on CPU count
worker_processes auto;
pid /tmp/nginx.pid;

# Basic event configuration
events {
    worker_connections 1024;
}

# Stream (TCP/UDP) proxying section
stream {
    # Optional: simple connection limiting to protect the backend
    # limit_conn_zone $binary_remote_addr zone=tcp_limit:10m;

    upstream promethean_session {
        # Backend raw TCP session port exposed by the server
        server server:2000;
        # Optional: enable TCP keepalive to help with idle sessions
        # keepalive 64;
    }

    server {
        # External listen port for raw TCP sessions
        listen 2001 ssl;
        ssl_certificate /root/.PrometheanProxy/Certificates/cert.pem;
        ssl_certificate_key /root/.PrometheanProxy/Certificates/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;

        # Forward to the backend upstream
        proxy_pass promethean_session;
        proxy_ssl on;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;

        # Optional: enable proxy timeouts (tune as needed)
        proxy_timeout 600s;
        proxy_connect_timeout 60s;

        # Optional: apply connection limiting
        # limit_conn tcp_limit 1024;
    }
}
